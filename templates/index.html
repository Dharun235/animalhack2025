<!-- templates/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Road Safety ‚Äî Animal & Person Detection (MVP)</title>
  <style>
    body { background:#111; color:#eee; font-family: Arial, sans-serif; margin:0; padding:16px; }
    .container { display:flex; gap:18px; align-items:flex-start; }
    .video-wrap { background:#000; padding:8px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    img#video { border-radius:6px; max-width:100%; display:block; }
    .panel { width:380px; }
    .card { background:#1b1b1b; padding:12px; border-radius:8px; margin-bottom:12px; }
    h1 { font-size:20px; margin:6px 0 10px 0; }
    .counters { display:flex; flex-wrap:wrap; gap:8px; }
    .counter { background:#0f1724; padding:8px 10px; border-radius:6px; min-width:110px; text-align:center; }
    .log { max-height:360px; overflow:auto; font-size:13px; }
    .log-item { border-bottom:1px solid rgba(255,255,255,0.03); padding:8px 0; }
    .alert { font-weight:700; color:#ffcc00; margin-bottom:6px; }
    .small { color:#bbb; font-size:13px; }
    button { background:#0ea5a2; color:#012; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>üêæ Road Safety ‚Äî Animal & Person Detection (MVP)</h1>
  <div class="container">
    <div class="video-wrap">
      <img id="video" src="/video_feed" width="800" height="600" alt="Live feed">
      <div style="text-align:center; margin-top:8px;">
        <span id="alert" class="alert">No hazards detected</span>
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="small">Real-time counters</div>
            <h2 style="margin:6px 0 0 0">Hazard Counts</h2>
          </div>
          <div><button id="clearBtn">Clear Counts</button></div>
        </div>

        <div class="counters" id="counters">
          <!-- counters populated by JS -->
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between;">
          <div>
            <div class="small">Recent detections</div>
            <h3 style="margin:6px 0 0 0">Hazard Log</h3>
          </div>
          <div class="small" id="logCount">0</div>
        </div>

        <div class="log" id="logList"></div>
      </div>

      <div class="card small">
        <div><strong>Notes:</strong></div>
        <ul>
          <li>Works with PC webcam (camera source index 0). For thermal, replace camera source later.</li>
          <li>Model runs locally ‚Äî inference speed depends on CPU/GPU. Use `yolov8n.pt` for speed.</li>
          <li>To add deer or specialized species, you'll need to fine-tune a model with labeled images.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- alert sound -->
  <audio id="beep" src="https://www.soundjay.com/buttons/beep-07.wav" preload="auto"></audio>

  <script>
    const HAZARD_CLASSES = ["person","dog","cat","horse","sheep","cow","bird"];
    let lastAlert = "";

    async function fetchStats() {
      try {
        const res = await fetch("/stats");
        const data = await res.json();
        updateUI(data);
      } catch (e) {
        console.error("Failed to fetch stats:", e);
      }
    }

    function updateUI(data) {
      // Alert
      const alertEl = document.getElementById('alert');
      if (data.alert && data.alert.length > 0) {
        alertEl.innerText = data.alert;
        if (data.alert !== lastAlert) {
          // play beep
          document.getElementById('beep').play().catch(()=>{});
          // small highlight
          alertEl.style.color = "#ffcc00";
          lastAlert = data.alert;
        }
      } else {
        alertEl.innerText = "No hazards detected";
        alertEl.style.color = "#bcd";
        lastAlert = "";
      }

      // Counters
      const countersDiv = document.getElementById('counters');
      countersDiv.innerHTML = "";
      // ensure all hazards shown (even zero)
      const counters = data.counters || {};
      for (const cls of HAZARD_CLASSES) {
        const count = counters[cls] || 0;
        const node = document.createElement('div');
        node.className = "counter";
        node.innerHTML = `<div style="font-weight:700">${cls}</div><div style="font-size:14px">${count}</div>`;
        countersDiv.appendChild(node);
      }

      // Log
      const logList = document.getElementById('logList');
      logList.innerHTML = "";
      const logs = data.logs || [];
      document.getElementById('logCount').innerText = logs.length;
      for (const item of logs) {
        const li = document.createElement('div');
        li.className = "log-item";
        li.innerHTML = `<div style="display:flex; justify-content:space-between">
                          <div><strong>${item.class}</strong> <span class="small">(${item.conf})</span></div>
                          <div class="small">${item.ts}</div>
                        </div>`;
        logList.appendChild(li);
      }
    }

    // Poll server every 800ms
    setInterval(fetchStats, 800);
    fetchStats();

    // Clear counts locally (UI only)
    document.getElementById('clearBtn').addEventListener('click', () => {
      // simple visual reset; server counters continue accumulating in this MVP.
      const countersDiv = document.getElementById('counters');
      for (const child of countersDiv.children) {
        child.querySelector('div:nth-child(2)').innerText = "0";
      }
    });
  </script>
</body>
</html>
